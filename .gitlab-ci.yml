stages:
  - build-toolchain

variables:
  TOOLCHAIN_IMAGE: $CI_REGISTRY/zeroth-robotics/OpenLCH/openlch-runtime-sdk:latest

.runner: &runner
  tags: 
    - linux-x64

build-toolchain:
  <<: *runner
  stage: build-toolchain
  services:
    - docker:dind
  image: docker:latest
  
  script:
      - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
      - docker pull $TOOLCHAIN_IMAGE:$CI_COMMIT_SHA || true
      - docker build --progress=plain --cache-from $TOOLCHAIN_IMAGE:$CI_COMMIT_SHA -t $TOOLCHAIN_IMAGE:$CI_COMMIT_SHA -f runtime-sdk/Dockerfile .
      - docker push $TOOLCHAIN_IMAGE:$CI_COMMIT_SHA
  only:
    - changes:
        - runtime-sdk/**/*
    - if: '$CI_COMMIT_BRANCH == "main"'
